variables:
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: ""
  POSTGRES_DB: project_ci_test
  DATABASE_PORT: 5432
  DATABASE_HOST: postgres
  POSTGRES_SSL: disable
  POSTGRES_TIMEZONE: Asia/Tehran
  POETRY_VIRTUALENVS_CREATE: "false"  # This is to ensure poetry uses the system Python
  PGPORT: 5432 # Change default port of postgres

default:
  image: python:3.12

  services:
    - postgres:15.3-alpine

#  cache:
#    paths:
#      - ~/.cache/pip/

  before_script:
    - export DATABASE_URL=postgres://postgres:@postgres:5432/project_ci_test
    - rm -rf "%CACHE_PATH%/%CI_PIPELINE_ID%"
    - add-apt-repository ppa:deadsnakes/ppa -y
    - apt-get -yq update
    - apt-get -yq install python3.12 python3-pip
    - pip install -U pip setuptools
    - pip install --upgrade poetry
    - poetry install

migrations:
  stage: build
  script:
    - poetry run python3 manage.py migrate


django-tests:
  stage: test
  script:
    - poetry run pytest

#cleanup_job:
#  stage: .pre
#  script:
#    - echo "Cleaning up"
#    - rm -rf "%CACHE_PATH%/%CI_PIPELINE_ID%"
#  when: always



